[include mainsail.cfg]
## Mainsail Settings

[include toolchanger/readonly-configs/toolchanger-include.cfg]
[include macros_heatsoak.cfg]
[include macros.cfg]
[include KAMP_Settings.cfg]


#####################################################################
#   Basic Shit
#####################################################################
[idle_timeout]
timeout: 1200
[pause_resume]
[exclude_object]
[force_move]
enable_force_move: true
[respond]
[gcode_arcs]
[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

# [verify_heater extruder]
# max_error: 160
# hysteresis: 8

# [include spoolboy.cfg]

# [include tdp_dock_autotune.cfg]
# [include tool_drop_detection.cfg]



#####################################################################
#   Printer
#####################################################################
[mcu]
##  Main MCU, all kinematic motors
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_470043000651303532383235-if00

[printer]
kinematics: corexy
max_velocity: 600
max_accel: 13000
max_z_velocity: 40
max_z_accel: 400
square_corner_velocity: 5.0
minimum_cruise_ratio: 0.5

#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x1]
# A Motor - Left Front
#high_precision_step_compress: False
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_x1]
uart_pin: PC4
interpolate: True
run_current: 1.5
sense_resistor: 0.100

[autotune_tmc stepper_x1]
motor: ldo-42sth48-2504ah
tuning_goal: performance
extra_hysteresis: 2


[stepper_y]
# B Motor - Left Rear
#high_precision_step_compress: False
homing_positive_dir: True
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: PG9
position_min: 0
##--------------------------------------------------------------------
position_endstop: 358
position_max: 358
##--------------------------------------------------------------------
homing_speed: 50   #Max 100
homing_retract_dist: 10
second_homing_speed: 5

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: True
run_current: 1.5
sense_resistor: 0.100

[autotune_tmc stepper_y]
motor: ldo-42sth48-2504ah
tuning_goal: performance
extra_hysteresis: 2


[stepper_x]
# A Motor - Right Rear
#high_precision_step_compress: False
homing_positive_dir: True
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200
#endstop_pin: tmc2209_stepper_y:virtual_endstop
endstop_pin: PG6
position_min: 0
##--------------------------------------------------------------------
position_endstop: 340
position_max: 340
##--------------------------------------------------------------------
homing_speed: 50 #Max 100
homing_retract_dist: 10
second_homing_speed: 5

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PC6
interpolate: True
run_current: 1.5
sense_resistor: 0.10

[autotune_tmc stepper_x]
motor: ldo-42sth48-2504ah
tuning_goal: performance
extra_hysteresis: 2


[stepper_y1]
# B Motor - Right Front
#high_precision_step_compress: False
step_pin: PG4
dir_pin: PC1
enable_pin: !PA0
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_y1]
uart_pin: PC7
interpolate: True
run_current: 1.5
sense_resistor: 0.10

[autotune_tmc stepper_y1]
motor: ldo-42sth48-2504ah
tuning_goal: performance
extra_hysteresis: 2

#####################################################################
#   Z Stepper Settings
#####################################################################

##  Z Stepper - Front Left
[stepper_z]
#high_precision_step_compress: False
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32
homing_retract_dist: 0
endstop_pin: probe:z_virtual_endstop
position_max: 300
position_min: -10

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: PF2
sense_resistor: 0.110
run_current: .8
stealthchop_threshold: 0

##  Z1 Stepper - Rear Left
[stepper_z1]
#high_precision_step_compress: False
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z1]
uart_pin: PE4
sense_resistor: 0.110
run_current: .8
stealthchop_threshold: 0

##  Z2 Stepper - Rear Right
[stepper_z2]
#high_precision_step_compress: False
step_pin: PE2
dir_pin: PE3
enable_pin: !PD4
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z2]
uart_pin: PE1
sense_resistor: 0.110
run_current: .8
stealthchop_threshold: 0

##  Z3 Stepper - Front Right
[stepper_z3]
#high_precision_step_compress: False
step_pin: PE6
dir_pin: !PA14
enable_pin: !PE0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z3]
uart_pin: PD3
sense_resistor: 0.110
run_current: .8
stealthchop_threshold: 0

#####################################################################
#   Temperature Sensors
#####################################################################

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor bed_edge]
sensor_type: Generic 3950
sensor_pin: PF4
min_temp: 0
max_temp: 120

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: cartographer
min_temp: 0
max_temp: 105


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
sensor_pin: PF3
heater_pin: PA3
sensor_type: Generic 3950
control: pid
max_power: 0.7
min_temp: 0
max_temp: 110
pid_Kp: 37.508
pid_Ki: 1.366
pid_Kd: 257.402

#####################################################################
#   Fans
#####################################################################

[controller_fan motors_fan]
pin: PA8
max_power: 1.0
fan_speed: 1
kick_start_time: 0
stepper: stepper_x

[fan_generic Nevermore]
pin: PE5

#####################################################################
#   Cartographer/Scanning
#####################################################################
[mcu cartographer]
serial: /dev/serial/by-id/usb-Cartographer_614e_270007800543304858353520-if00
restart_method: command

[cartographer]
mcu: cartographer
#backlash_comp: 0.1
x_offset: 0.0
#   X offset of cartographer from the nozzle.
y_offset: 25
verbose: No

[cartographer touch]
UNSAFE_max_touch_temperature: 180
max_samples: 15

[cartographer scan]

[bed_mesh]
zero_reference_position: 170, 175    
speed: 150
horizontal_move_z: 5
#    height of scanner during bed mesh scan
mesh_min: 40, 90
#    start point of bed mesh [X, Y]
mesh_max: 300, 345
#    end point of bed mesh [X, Y]
probe_count: 30, 30
mesh_pps: 0,0
adaptive_margin: 10

[quad_gantry_level]
gantry_corners:
    -60,-10
    410,420
points:
    60,90
    60,325
    300,325
    300,90
speed: 450
horizontal_move_z: 12
retries: 5
retry_tolerance: 0.0075
max_adjust: 20

[adxl345 carto]
cs_pin: cartographer:PA3 # For Cartographer V3
spi_bus: spi1

#####################################################################
#   Input Shaping
#####################################################################

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
number_of_results_to_keep: 10
keep_raw_data: False
show_macros_in_webui: True
timeout: 600
measurements_chunk_size: 2
max_freq: 200
dpi: 300

[input_shaper]
shaper_type_x: 2hump_ei
shaper_freq_x: 85.2
damping_ratio_x: 0.049
shaper_type_y: ei
shaper_freq_Y: 60
damping_ratio_y: 0.053

[resonance_tester]
accel_chip: adxl345 T0
probe_points: 170, 175, 40
#max_smoothing:
#   Maximum input shaper smoothing to allow for each axis during shaper
#   auto-calibration (with 'SHAPER_CALIBRATE' command). By default no
#   maximum smoothing is specified. Refer to Measuring_Resonances guide
#   for more details on using this feature.
#move_speed: 50
#   The speed (in mm/s) to move the toolhead to and between test points
#   during the calibration. The default is 50.
#min_freq: 5
#   Minimum frequency to test for resonances. The default is 5 Hz.
#max_freq: 133.33
#   Maximum frequency to test for resonances. The default is 133.33 Hz.
accel_per_hz: 100
#   This parameter is used to determine which acceleration to use to
#   test a specific frequency: accel = accel_per_hz * freq. Higher the
#   value, the higher is the energy of the oscillations. Can be set to
#   a lower than the default value if the resonances get too strong on
#   the printer. However, lower values make measurements of
#   high-frequency resonances less precise. The default value is 75
#   (mm/sec).
#hz_per_sec: 1
#   Determines the speed of the test. When testing all frequencies in
#   range [min_freq, max_freq], each second the frequency increases by
#   hz_per_sec. Small values make the test slow, and the large values
#   will decrease the precision of the test. The default value is 1.0
#   (Hz/sec == sec^-2).
sweeping_accel: 400
#   An acceleration of slow sweeping moves. The default is 400 mm/sec^2.
#   A period of slow sweeping moves. Setting this parameter to 0
#   disables slow sweeping moves. Avoid setting it to a too small
#   non-zero value in order to not poison the measurements.
#   The default is 1.2 sec which is a good all-round choice.
sweeping_period: 1.2

#####################################################################
#   Stuff that goes last
#####################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.4967326625804716,1.9969107345380328,0.8487291010043437,0.27298630237568816,0.4282691596077628,0.8277183982354197,-0.2621824205179022,-0.8920536095148824,0.28692492662977037,0.49522598215210223
#*# domain = 3.2354654751235406e-07,3.3315720531349216e-07
#*# z_offset = 0
#*# reference_temperature = 22.64
#*# software_version = 1.3.3
#*# mcu_version = CARTOGRAPHER 5.0.0
#*#
#*# [cartographer touch_model default]
#*# threshold = 720
#*# speed = 2
#*# z_offset = -0.1
#*# software_version = 1.3.3
#*# mcu_version = CARTOGRAPHER 5.0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.239161, 0.246046, 0.235711, 0.222071, 0.215111, 0.204854, 0.201152, 0.194343, 0.180257, 0.162743, 0.144904, 0.134133, 0.123728, 0.116491, 0.107321, 0.109241, 0.112865, 0.123526, 0.134334, 0.152050, 0.173390, 0.185548, 0.190829, 0.187310, 0.183786, 0.176724, 0.169846, 0.162743, 0.162644, 0.169640
#*# 	  0.225540, 0.222071, 0.208138, 0.201152, 0.197648, 0.190829, 0.180257, 0.176929, 0.166091, 0.148683, 0.130742, 0.116491, 0.109241, 0.098315, 0.091012, 0.091012, 0.094662, 0.105604, 0.119910, 0.137929, 0.159184, 0.173390, 0.183786, 0.187310, 0.183786, 0.180257, 0.173287, 0.169640, 0.162743, 0.162743
#*# 	  0.208347, 0.201355, 0.190829, 0.183991, 0.180257, 0.169846, 0.166297, 0.159184, 0.152050, 0.137929, 0.120112, 0.101962, 0.094662, 0.083680, 0.072848, 0.072848, 0.072848, 0.087349, 0.098315, 0.114577, 0.134334, 0.152257, 0.166297, 0.176724, 0.180257, 0.180257, 0.176724, 0.166297, 0.159184, 0.162743
#*# 	  0.187310, 0.180257, 0.169846, 0.162743, 0.159184, 0.152050, 0.141519, 0.141519, 0.130742, 0.116289, 0.098315, 0.087349, 0.076532, 0.069165, 0.058270, 0.058071, 0.065470, 0.072848, 0.083680, 0.098315, 0.123526, 0.141519, 0.155620, 0.169640, 0.176929, 0.183786, 0.180257, 0.166297, 0.159184, 0.159184
#*# 	  0.162743, 0.159184, 0.148683, 0.141519, 0.137929, 0.127136, 0.123526, 0.116491, 0.109241, 0.098315, 0.076532, 0.065470, 0.058071, 0.050642, 0.047120, 0.047120, 0.050842, 0.058270, 0.069165, 0.083885, 0.105604, 0.123526, 0.141519, 0.155620, 0.166297, 0.173185, 0.169640, 0.159184, 0.148483, 0.152050
#*# 	  0.141519, 0.137929, 0.127136, 0.123526, 0.120011, 0.114577, 0.109241, 0.098315, 0.087546, 0.072848, 0.058270, 0.047120, 0.039666, 0.035927, 0.035927, 0.035927, 0.043400, 0.050742, 0.058071, 0.076532, 0.098315, 0.120112, 0.137929, 0.152050, 0.159184, 0.162743, 0.159184, 0.148683, 0.141519, 0.137929
#*# 	  0.130742, 0.127136, 0.123526, 0.116289, 0.109241, 0.101962, 0.098315, 0.091012, 0.083885, 0.065669, 0.050842, 0.039666, 0.032191, 0.028643, 0.028441, 0.028643, 0.035927, 0.043400, 0.054559, 0.072848, 0.101962, 0.130742, 0.148683, 0.155620, 0.152050, 0.148683, 0.144904, 0.137929, 0.134334, 0.137929
#*# 	  0.116289, 0.112767, 0.105604, 0.101962, 0.091209, 0.083885, 0.080014, 0.080212, 0.072649, 0.058270, 0.039666, 0.032191, 0.028643, 0.021127, 0.021127, 0.026664, 0.032191, 0.047120, 0.065470, 0.083680, 0.116491, 0.148483, 0.162743, 0.162743, 0.152257, 0.148683, 0.137929, 0.127136, 0.123728, 0.123526
#*# 	  0.112865, 0.105401, 0.098315, 0.098315, 0.087349, 0.076532, 0.069165, 0.069165, 0.065470, 0.052601, 0.035927, 0.028441, 0.024887, 0.021127, 0.021127, 0.028441, 0.043400, 0.058071, 0.069364, 0.091012, 0.119910, 0.155620, 0.169846, 0.166297, 0.159184, 0.146794, 0.132538, 0.123526, 0.119910, 0.127136
#*# 	  0.091012, 0.087349, 0.087349, 0.087349, 0.076532, 0.069165, 0.058270, 0.054359, 0.050842, 0.035927, 0.024887, 0.017368, 0.013596, 0.009826, 0.013596, 0.024693, 0.039666, 0.050842, 0.069165, 0.087546, 0.119910, 0.148683, 0.166091, 0.166297, 0.155620, 0.141519, 0.127136, 0.112865, 0.109241, 0.110952
#*# 	  0.074690, 0.069364, 0.069165, 0.069165, 0.065470, 0.058071, 0.047120, 0.043400, 0.035927, 0.021127, 0.009826, 0.002254, -0.001336, -0.001336, 0.002254, 0.013596, 0.024887, 0.043400, 0.065470, 0.083885, 0.109241, 0.137929, 0.159184, 0.166297, 0.155620, 0.137729, 0.112865, 0.101962, 0.094662, 0.098315
#*# 	  0.054359, 0.052601, 0.054359, 0.054559, 0.050842, 0.043400, 0.035927, 0.032191, 0.024693, 0.013596, 0.002254, -0.001532, -0.005332, -0.008933, -0.005332, 0.006043, 0.024887, 0.045163, 0.065470, 0.087349, 0.116491, 0.144904, 0.166297, 0.176724, 0.162743, 0.137929, 0.112865, 0.094662, 0.091209, 0.094662
#*# 	  0.043400, 0.043400, 0.043400, 0.043400, 0.047120, 0.039666, 0.034156, 0.028441, 0.021029, 0.009826, 0.002254, -0.005136, -0.008933, -0.012744, -0.008933, 0.002458, 0.024693, 0.043400, 0.061969, 0.085617, 0.114577, 0.144904, 0.169640, 0.176929, 0.159184, 0.130742, 0.105604, 0.087546, 0.083680, 0.091012
#*# 	  0.032288, 0.032191, 0.035927, 0.039666, 0.039666, 0.035927, 0.032191, 0.024887, 0.017368, 0.009826, -0.001434, -0.005332, -0.012744, -0.016553, -0.012744, 0.002254, 0.024887, 0.047120, 0.065470, 0.091012, 0.116289, 0.146794, 0.167969, 0.169846, 0.152050, 0.127136, 0.101962, 0.087546, 0.083885, 0.080014
#*# 	  0.032288, 0.028441, 0.028441, 0.028643, 0.032191, 0.032191, 0.028441, 0.021127, 0.017368, 0.009826, -0.001434, -0.008933, -0.012744, -0.016553, -0.012744, -0.001336, 0.021127, 0.039666, 0.061769, 0.083885, 0.112670, 0.137929, 0.155620, 0.155620, 0.137929, 0.116491, 0.098315, 0.083680, 0.080212, 0.083885
#*# 	  0.024887, 0.024693, 0.021127, 0.021127, 0.021127, 0.021127, 0.021127, 0.017368, 0.009826, 0.006043, -0.008933, -0.009130, -0.012744, -0.016553, -0.012744, -0.001336, 0.017368, 0.039666, 0.058071, 0.080212, 0.105604, 0.130742, 0.137929, 0.134334, 0.119910, 0.105604, 0.089180, 0.076532, 0.072848, 0.076532
#*# 	  0.017368, 0.013596, 0.009826, 0.011809, 0.013596, 0.017368, 0.013596, 0.006239, -0.001532, -0.009032, -0.020376, -0.020376, -0.024006, -0.024204, -0.020376, -0.005136, 0.013596, 0.032191, 0.047120, 0.069265, 0.101962, 0.123526, 0.127136, 0.116491, 0.105604, 0.091209, 0.080212, 0.069165, 0.065669, 0.076334
#*# 	  0.002254, -0.001532, -0.001532, 0.002458, 0.006239, 0.009826, 0.006043, 0.002254, -0.005332, -0.020376, -0.020376, -0.024204, -0.024204, -0.024204, -0.016553, -0.005332, 0.009826, 0.026664, 0.043400, 0.065470, 0.091209, 0.112865, 0.116289, 0.109241, 0.098315, 0.087349, 0.076532, 0.065669, 0.063719, 0.065470
#*# 	  0.002254, -0.003334, -0.008933, -0.005136, -0.001336, 0.006043, 0.002254, -0.001532, -0.008933, -0.012744, -0.024006, -0.027832, -0.024204, -0.024204, -0.016553, -0.005136, 0.013596, 0.024887, 0.043400, 0.061969, 0.083885, 0.101962, 0.109038, 0.105401, 0.098315, 0.091209, 0.080212, 0.069165, 0.065470, 0.069165
#*# 	  -0.005136, -0.005136, -0.008933, -0.005332, -0.001434, 0.002458, 0.002458, 0.002254, -0.005332, -0.012744, -0.016553, -0.020376, -0.020376, -0.016553, -0.005332, 0.002458, 0.020932, 0.035927, 0.050842, 0.069165, 0.087546, 0.105604, 0.112865, 0.116289, 0.112865, 0.105604, 0.094662, 0.080212, 0.076532, 0.072848
#*# 	  -0.001336, -0.005136, -0.009130, -0.005332, 0.000459, 0.006043, 0.006141, 0.004149, 0.002254, -0.008933, -0.016553, -0.016553, -0.016553, -0.008933, -0.001336, 0.009826, 0.028643, 0.047120, 0.065669, 0.083885, 0.101962, 0.116491, 0.127338, 0.134334, 0.130742, 0.123728, 0.112670, 0.094662, 0.087349, 0.087349
#*# 	  -0.005136, -0.005136, -0.008933, -0.005332, -0.001336, 0.002458, 0.006239, 0.006239, 0.002458, -0.008933, -0.016553, -0.016553, -0.009130, -0.005136, 0.006239, 0.024887, 0.039666, 0.061969, 0.080212, 0.094662, 0.116289, 0.134334, 0.145104, 0.152050, 0.148683, 0.141519, 0.127136, 0.105604, 0.092936, 0.087546
#*# 	  -0.007138, -0.009130, -0.012744, -0.005136, 0.002254, 0.002254, 0.002458, 0.006043, -0.001532, -0.012744, -0.016553, -0.020178, -0.012744, -0.005136, 0.006043, 0.021127, 0.043400, 0.061969, 0.083885, 0.101962, 0.123526, 0.141519, 0.155620, 0.166091, 0.162743, 0.155620, 0.137929, 0.116289, 0.094867, 0.094662
#*# 	  -0.012744, -0.012744, -0.012744, -0.005136, -0.001336, 0.006043, 0.002458, 0.002254, -0.001336, -0.008933, -0.016553, -0.016553, -0.008933, 0.002458, 0.017368, 0.028643, 0.047120, 0.072848, 0.092936, 0.114577, 0.134334, 0.152050, 0.169640, 0.180257, 0.183786, 0.180257, 0.159184, 0.134334, 0.109241, 0.100241
#*# 	  0.009826, 0.017368, 0.017368, 0.021127, 0.028441, 0.024887, 0.024887, 0.028441, 0.024887, 0.013596, 0.006043, -0.001336, 0.006043, 0.017165, 0.032191, 0.028441, 0.058270, 0.087546, 0.109241, 0.130742, 0.152257, 0.173185, 0.190829, 0.206496, 0.211627, 0.204651, 0.183786, 0.148683, 0.123526, 0.101962
#*# 	  0.024790, 0.028441, 0.035927, 0.035927, 0.047120, 0.050642, 0.050842, 0.047120, 0.047120, 0.039666, 0.028441, 0.024887, 0.032385, 0.039666, 0.054559, 0.065669, 0.076532, 0.091209, 0.112865, 0.127338, 0.152050, 0.176929, 0.194343, 0.190829, 0.197851, 0.190829, 0.169846, 0.143211, 0.120112, 0.105604
#*# 	  0.050642, 0.047120, 0.058171, 0.058270, 0.069165, 0.065470, 0.065470, 0.061769, 0.054359, 0.047120, 0.047120, 0.036129, 0.036129, 0.035927, 0.047120, 0.069265, 0.069165, 0.076334, 0.083885, 0.119910, 0.145104, 0.155620, 0.166297, 0.180257, 0.194343, 0.187310, 0.173390, 0.152050, 0.137929, 0.130742
#*# 	  0.061769, 0.065669, 0.072848, 0.080212, 0.080212, 0.080212, 0.076532, 0.076532, 0.072848, 0.069165, 0.058270, 0.054559, 0.054559, 0.058270, 0.061769, 0.065470, 0.072848, 0.083885, 0.101962, 0.120112, 0.137729, 0.152257, 0.166297, 0.176724, 0.180257, 0.173390, 0.162743, 0.148483, 0.137929, 0.132538
#*# 	  0.087349, 0.091209, 0.101962, 0.105604, 0.109038, 0.101962, 0.101962, 0.105503, 0.098315, 0.092936, 0.083885, 0.080014, 0.080014, 0.076532, 0.076532, 0.080212, 0.083885, 0.094662, 0.105604, 0.119910, 0.137829, 0.148483, 0.159184, 0.166297, 0.169846, 0.166297, 0.159184, 0.148483, 0.141319, 0.143211
#*# 	  0.116491, 0.120112, 0.127136, 0.130742, 0.130742, 0.130742, 0.127136, 0.127136, 0.127136, 0.119910, 0.109241, 0.101962, 0.098315, 0.098519, 0.098315, 0.098315, 0.098315, 0.105503, 0.116491, 0.123526, 0.137929, 0.148483, 0.159184, 0.162743, 0.166297, 0.162743, 0.155620, 0.148483, 0.141319, 0.141519
#*# min_x = 60.0
#*# min_y = 90.0
#*# max_x = 300.0
#*# max_y = 345.0
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
